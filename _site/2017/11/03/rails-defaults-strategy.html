<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>A Strategy For Configs And Defaults In Rails | Bat Country Coding</title>

    <link rel="stylesheet" href="/assets/css/style.css?v=e43a7f79d2960a0ba7c86584bb47298a99d2ae61">
    <meta name="viewport" content="width=device-width">
    <link href="https://fonts.googleapis.com/css?family=Inconsolata|Oswald|Special+Elite" rel="stylesheet">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link rel="shortcut icon" href="http://batcountrycoding.com/favicon.ico" type="image/x-icon">
    <link rel="icon" href="http://batcountrycoding.com/favicon_ani.ico" type="image/x-icon">
    <meta property="og:image" content="http://localhost:4000/assets/images/batcountry1.jpg" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:width" content="631" />
<meta property="og:image:height" content="298" />
<meta property="og:title" content="A Strategy For Configs And Defaults In Rails" />
<meta property="og:description" content="The approach described here uses three Gems which work well together to provide a very flexible and powerful strategy for managing all an app's settings." />
<link rel="image_src" href="http://localhost:4000/assets/images/batcountry1.jpg" />

  </head>
  <body>
    <div class="wrapper">

      <!--
@Author: msmiller
@Date:   2019-08-15 15:14:12
@Last Modified by:   msmiller
@Last Modified time: 2019-08-15 15:53:52

Copyright (c) 2017-2018 Sharp Stone Codewerks / Mark S. Miller
-->

<header style="border-right: 1px solid #ddd;">
  <center><a href="http://localhost:4000"><img src="/assets/images/batcountry1.jpg"></a></center>
  <h1 id="sitename"><a href="http://localhost:4000">Bat Country Coding</a></h1>
  <h1 id="sitedesc">A Technology Blog<span class="blinking-cursor">|</span></h1>
  <hr>
  <p class="view"><img src="/assets/images/chevron.png"> <a href="/posts.html">All Posts</a></p>
  <hr>
  <p class="view"><img src="/assets/images/chevron.png"> <a href="http://sharpstonecodewerks.com" target="_away">Sharp Stone Codewerks</a></p>
  <p class="view"><img src="/assets/images/chevron.png"> <a href="http://www.abstretta.com" target="_away">Abstretta.com</a></p>
  <p class="view"><img src="/assets/images/chevron.png"> <a href="http://www.bibliogrify.com" target="_away">Bibliogrify.com</a></p>
  <hr>
  <p class="view"><img src="/assets/images/chevron.png"> <a href="https://github.com/msmiller" target="_away">Github</a></p>
  <p class="view"><img src="/assets/images/chevron.png"> <a href="https://www.linkedin.com/in/msmiller" target="_away">LinkedIn</a></p>

  

  

  
</header>

      <section>

        <h1>A Strategy For Configs And Defaults In Rails</h1>
        <p class="date">November 03, 2017</p>
        <div class="content"><p>There’s a plethora of configurations and default settings that are needed in a Rails App. Some examples include:</p>

<ul>
  <li>Defining what UI icons to use for objects across the system.</li>
  <li>Defaults for selectors in forms.</li>
  <li>Feature enables.</li>
  <li>Instance settings (i.e. a web server is different than a background server).</li>
  <li>Install settings in the case where your system is being licensed out to another user.</li>
  <li>Default values for models.</li>
</ul>

<p>And of course, this all has to get mapped across the various deploy environments. Sure, you can put some of these settings in the models themselves, but unless you do it consistently you’ll find yourself hunting for these settings. And, yes, you could put these in initializers - but they’re really not initializers, are they? Complicating this is that somethings you want your settings to be calculated off of some default. That is, sometimes what you need to provide the system is derived from a setting, not just the raw settings.</p>

<p>The approach described here uses three Gems which work well together to provide a very flexible and powerful strategy for managing all these settings.</p>

<h3 id="dotenv-rails">dotenv-rails</h3>

<p><a href="https://github.com/bkeepers/dotenv">https://github.com/bkeepers/dotenv</a></p>

<p>So let’s “start at the bottom” as it were. <strong>Dotenv</strong> is a nice little Gem which automatically loads environment files before your server(s) start up. This mirrors the configuration variables that Heroku uses, so it’s a nice way to keep consistent mechanisms for these settings.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- root/
  - .env.development
  - .env.test
  - .env.foo
</code></pre></div></div>

<p>A dotenv file is like any other shell file. You simply put your environment variables in it. Note that I like to add an environment variable for <code class="highlighter-rouge">INSTANCE</code> so that if I have different deployments, so maybe the configuration of a Rescue server needs different settings, I’m covered.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export S3_BUCKET=YOURS3BUCKET
export SECRET_KEY=YOURSECRETKEYGOESHERE
export INSTANCE=staging
</code></pre></div></div>

<p>To load it using the standard files (these are described on the Github page), all you need to add is the following to your <code class="highlighter-rouge">.../config/environments/</code> file:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>require 'dotenv/load'
</code></pre></div></div>

<p>You use the settings in the usual way:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>config.fog_directory = ENV['S3_BUCKET']
</code></pre></div></div>

<p>So now you have global settings, environments, and credentials handled and in a way that will be consistent with your Heroku hosting. If you use standard Linux server, you can of course continue to use Dotenv to load <code class="highlighter-rouge">.env.production</code> and it all works great.</p>

<p><em><strong>NOTE:</strong> You don’t want to check these files into your version control since they’ll usually have credentials that you don’t want being public.</em></p>

<h3 id="settingslogic">settingslogic</h3>

<p><a href="https://github.com/binarylogic/settingslogic">https://github.com/binarylogic/settingslogic</a></p>

<p>SettingsLogic is a really slick and useful Gem which loads a set up configuration data from a YAML file and then provides it as a model. This means that the model can also massage the data as needed - for instance, if a configuration hash is to be provided    to a form SELECT in a specific way.</p>

<p>The files you’ll add, in addition to the Gem itself will be something like the following. I like to split out the SettingsLogic classes and settings files from everything else so things don’t get confused.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- root/
  - app/
    - models/
      - settingslogic/
        - defaults.rb
        - facade.rb
        - instance.rb
    - config/
      - settingslogic/
        - common/
          - defaults.yml
            - dev/
              - instance.yml
              - facade.yml
            - test/
            - foo/
</code></pre></div></div>

<p>I like to use the <code class="highlighter-rouge">facade</code> settings for defining things like what icon to use for different things in the system, as well as branding attributes and the like. This way everything that’s related to the look and feel of the App is more or less in one place.</p>

<p>So, a SettingsLogic model looks something like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Settingslogic</span><span class="o">::</span><span class="no">Defaults</span> <span class="o">&lt;</span> <span class="no">Settingslogic</span>
  <span class="n">source</span> <span class="s2">"</span><span class="si">#{</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="si">}</span><span class="s2">/config/settingslogic/common/defaults.yml"</span>
  <span class="n">namespace</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">env</span>
<span class="k">end</span>
</code></pre></div></div>

<p>And if your YAML file looks like:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">defaults</span><span class="pi">:</span> <span class="nl">&amp;defaults</span>
  <span class="na">users</span><span class="pi">:</span>
    <span class="na">foo</span><span class="pi">:</span>             <span class="s">bar</span>
    <span class="na">ack</span><span class="pi">:</span>             <span class="s">oop</span>

<span class="na">development</span><span class="pi">:</span>
  <span class="s">&lt;&lt;</span><span class="pi">:</span> <span class="nv">*defaults</span>

<span class="na">test</span><span class="pi">:</span>
  <span class="s">&lt;&lt;</span><span class="pi">:</span> <span class="nv">*defaults</span>

<span class="na">production</span><span class="pi">:</span>
    <span class="s">&lt;&lt;</span><span class="pi">:</span> <span class="nv">*defaults</span>
</code></pre></div></div>

<p>… then you would be able to get at the settings as …</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Settingslogic</span><span class="p">.</span><span class="nf">defaults</span><span class="p">.</span><span class="nf">users</span><span class="p">.</span><span class="nf">foo</span> <span class="c1"># =&gt; 'bar'</span>
<span class="no">Settingslogic</span><span class="p">.</span><span class="nf">defaults</span><span class="p">.</span><span class="nf">users</span><span class="p">.</span><span class="nf">ack</span> <span class="c1"># =&gt; 'oop'</span>
</code></pre></div></div>

<p>Note that SettingsLogic already handles development, test, and production environments. However, when you’re using Heroku your “staging” environment is often configured as “production”. This is where the <code class="highlighter-rouge">INSTANCE</code> setting from your Dotenv variables comes into play.</p>

<p>And since SettingsLogic provides configuration as a model, you can add in functions to make it more helpful - and to save having these little utility functions spread all over the rest of your code.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Settingslogic</span><span class="o">::</span><span class="no">Defaults</span> <span class="o">&lt;</span> <span class="no">Settingslogic</span>
  <span class="n">source</span> <span class="s2">"</span><span class="si">#{</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="si">}</span><span class="s2">/config/settingslogic/common/defaults.yml"</span>
  <span class="n">namespace</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">env</span>
  
  <span class="k">def</span> <span class="nf">is_foo_and_not_ack?</span>
    <span class="p">(</span><span class="n">foo</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ack</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>And if you need to use a hash from the YAML to drive some of the UI, it’d look like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="sx">%= f.select  :some_selector,
              Settingslogic::Defines.some_model.some_selector_options %&gt;
    
</span></code></pre></div></div>

<h3 id="default_value_for">default_value_for</h3>

<p><a href="https://github.com/FooBarWidget/default_value_for">https://github.com/FooBarWidget/default_value_for</a></p>

<p>The DefaultValueFor Gem adds the ability to set defaults to models up in the declarations section. These then get executed when a new object is created. It makes your default-setting much more readable. An example would be:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">default_value_for</span> <span class="ss">:name</span><span class="p">,</span> <span class="s2">"(no name)"</span>
  <span class="n">default_value_for</span> <span class="ss">:last_seen</span> <span class="k">do</span>
    <span class="no">Time</span><span class="p">.</span><span class="nf">now</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">u</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span>
<span class="n">u</span><span class="p">.</span><span class="nf">name</span>       <span class="c1"># =&gt; "(no name)"</span>
<span class="n">u</span><span class="p">.</span><span class="nf">last_seen</span>  <span class="c1"># =&gt; Mon Sep 22 17:28:38 +0200 2008</span>
</code></pre></div></div>

<p>So, now what we can do is combine this with what we set up with SettingsLogic:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">default_value_for</span> <span class="ss">:foo</span><span class="p">,</span> <span class="no">SettingsLogic</span><span class="o">::</span><span class="no">Defaults</span><span class="p">.</span><span class="nf">user</span><span class="p">.</span><span class="nf">foo</span>
  <span class="n">default_value_for</span> <span class="ss">:ack</span><span class="p">,</span> <span class="no">SettingsLogic</span><span class="o">::</span><span class="no">Defaults</span><span class="p">.</span><span class="nf">user</span><span class="p">.</span><span class="nf">ack</span>
<span class="k">end</span>
</code></pre></div></div>

<p>What’s nice about this delegation of responsibility is that the settings of a default is handled in a very readable way. And the place where the settings are defined is handled in a very consistent and easy-to-maintain way. You’ll know right where to look for a default if you need to change it. And if the default is dependent on environment or instance configurations, your actual Ruby Model code is completely isolated from that.</p>

<h3 id="wrapping-it-all-up">Wrapping It All Up</h3>

<p>So, to sum it up, we have three Gems which provide the following capabilities:</p>

<ul>
  <li><code class="highlighter-rouge">Dotenv</code> manages settings for credentials and instances across environments.</li>
  <li><code class="highlighter-rouge">SettingsLogic</code> manages YAML-driven settings and default values across environments, and provides a place to put utility functions that relate to these settings.</li>
  <li><code class="highlighter-rouge">DefaultValueFor</code> provides an easy-to-read mechanism for setting Model defaults that can be driven off the SettingsLogic models.</li>
</ul>

<p>Your Model code is insulated from trying to figure out what the default could be. Your View code has one central resource group to reference for icons, selector options, and so on. And if you need to install an instance on a customer server you can quickly and easily spin up configurations for that without having to wade through a lot of code.</p>

<p>There are probably more elegant or fancy ways to accomplish what this does. But I tend to err on the side of ease of maintenance over complex functionality. I use the technique on multiple projects and any time I need to make configuration changes it’s always a quick and easy matter. The gotcha with complex configuration Gems is that you don’t use them that often. Your core settings don’t usually change frequently. So if you need to make “just a quick config change” for a project or client, you don’t want to burn half an hour trying to remember <em>how</em> to make the change because the fancy Gem you picked has a unique syntax or way or handing off settings. YAML is YAML is YAML … it’s easy to work with and easy to read.</p>
</div>
        <div class="share-page">
    Share this on &rarr;
    <a href="https://twitter.com/intent/tweet?text=A Strategy For Configs And Defaults In Rails&url=http://localhost:4000/2017/11/03/rails-defaults-strategy.html" rel="nofollow" target="_blank" title="Share on Twitter">Twitter</a>
    <a href="https://facebook.com/sharer.php?u=http://localhost:4000/2017/11/03/rails-defaults-strategy.html" rel="nofollow" target="_blank" title="Share on Facebook">Facebook</a>
    <a href="https://plus.google.com/share?url=http://localhost:4000/2017/11/03/rails-defaults-strategy.html" rel="nofollow" target="_blank" title="Share on Google+">Google+</a>
</div>


      </section>
      <footer>
        
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="/assets/js/scale.fix.js"></script>


  
    <script type="text/javascript">
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
      try {
        var pageTracker = _gat._getTracker("UA-145823739-2");
      pageTracker._trackPageview();
      } catch(err) {}
    </script>
  
  </body>
</html>
